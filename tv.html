<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Fast - IPTV</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --primary-color: #E50914;
            --background-color: #141414;
            --text-color: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            overflow-x: hidden;
        }
        
        #login-container { display: none; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://image.tmdb.org/t/p/original/VlHt2blBkncfAqPnuTtraG2flp.jpg') no-repeat center center/cover; }
        #login-container.active { display: flex; }

        .app-wrapper { display: none; }
        .app-wrapper.active { display: block; padding-top: 60px; }
        @media (min-width: 768px) {
            .app-wrapper.active { padding-top: 0; }
        }

        .login-box { background-color: rgba(0,0,0,0.85); padding: 4rem; border-radius: 8px; max-width: 450px; width: 100%; }
        .login-box h1 { text-align: center; margin-bottom: 2rem; }
        .login-form { display: flex; flex-direction: column; gap: 1rem; }
        .login-form input { background-color: #333; border: none; border-radius: 5px; color: white; padding: 1rem; font-size: 1rem; }
        .login-form button { background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 1rem; font-size: 1.2rem; font-weight: 700; cursor: pointer; margin-top: 1.5rem; }
        #login-error { color: #e87c03; margin-top: 1rem; text-align: center; min-height: 1.2em; }

        .page { display: none; animation: fadeIn 0.4s ease-in-out; }
        .page.active { display: block; }
        .player-page.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mobile-header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 101;
            padding: 1rem 1rem 0.75rem;
            padding-top: env(safe-area-inset-top, 1rem);
            border-bottom: 1px solid #333;
        }
        .mobile-header h1 { font-size: 1.2rem; font-weight: 500; }

        .navbar-desktop { display: none; position: fixed; top: 0; width: 100%; padding: 1rem 3rem; background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%); align-items: center; z-index: 100; transition: background-color 0.3s; }
        .navbar-desktop .logo { color: var(--primary-color); font-size: 1.8rem; font-weight: 700; margin-right: 2rem; }
        .navbar-desktop .nav-links { list-style: none; display: flex; gap: 1.5rem; flex-grow: 1; align-items: center; }
        .nav-link a { color: var(--text-color); text-decoration: none; font-size: 1rem; transition: color 0.2s; cursor: pointer; }
        .nav-link a:hover, .nav-link a.active { color: #b3b3b3; font-weight: 700; }
        
        .profile { 
            position: relative; 
            margin-left: auto; 
            padding-bottom: 15px;
        }
        .profile img { border-radius: 50%; width: 40px; height: 40px; cursor: pointer; }
        .profile-menu { 
            display: none; 
            position: absolute; 
            right: 0; 
            top: 45px;
            background-color: #181818; 
            border-radius: 5px; 
            overflow: hidden; 
            min-width: 150px; 
        }
        .profile:hover .profile-menu { display: block; }
        .profile-menu button { background: none; border: none; color: white; padding: 0.75rem 1.5rem; cursor: pointer; width: 100%; text-align: left; font-size: 1rem; }
        .profile-menu button:hover { background-color: #333; }

        .hero-section { height: 60vh; display: flex; flex-direction: column; justify-content: center; padding: 0 5%; position: relative; background-size: cover; background-position: center center; }
        .hero-content { max-width: 500px; position: relative; z-index: 2; }
        .hero-title { font-size: 2.5rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        
        .media-card { flex: 0 0 150px; aspect-ratio: 10 / 16; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.3s ease; background-color: #222; display: flex; align-items: center; justify-content: center; text-align: center; position: relative; }
        .media-card img { width: 100%; height: 100%; object-fit: cover; }
        .media-card:hover { transform: scale(1.05); }
        .media-card-title { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); font-size: 0.8rem; padding: 5px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }

        .generic-page { padding: 1rem 5%; }
        .loader-container { display: none; text-align: center; padding: 2rem; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }

        .player-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 200; display: none; align-items: center; justify-content: center; }
        .player-page video { max-width: 100%; max-height: 100%; outline: none; }
        .back-from-player { position: absolute; top: 2rem; left: 2rem; background: rgba(0,0,0,0.5); border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .back-from-player svg { width: 25px; height: 25px; fill: white; }

        #series-details-backdrop { height: 60vh; background-size: cover; background-position: center top; position: relative; }
        #series-details-backdrop::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, var(--background-color) 10%, transparent 50%); }
        #series-details-info { padding: 2rem 5%; margin-top: -10vh; position: relative; z-index: 2; }
        #series-details-info h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        #series-details-plot { margin-bottom: 1.5rem; color: #ccc; }
        .season-selector { margin-bottom: 2rem; }
        .season-selector select { background: #333; color: white; padding: 0.5rem 1rem; border-radius: 5px; border: 1px solid #555; font-size: 1rem; }
        .episode-list { display: flex; flex-direction: column; gap: 1rem; }
        .episode-item { display: flex; align-items: center; gap: 1rem; background: #222; padding: 1rem; border-radius: 5px; cursor: pointer; }
        .episode-item:hover { background: #333; }
        .episode-item img { width: 150px; height: 84px; object-fit: cover; border-radius: 3px; }

        .navbar-mobile { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background-color: rgba(20, 20, 20, 0.85); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; z-index: 100; border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { background: none; border: none; color: #8e8e8e; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; cursor: pointer; flex-grow: 1; }
        .nav-item img { width: 24px; height: 24px; filter: invert(58%); }
        .nav-item.active { color: var(--text-color); }
        .nav-item.active img { filter: none; }
        
        #page-search { padding: 1rem 5%; }
        .search-bar { display: flex; align-items: stretch; background-color: #333; border-radius: 5px; margin-bottom: 2rem; }
        .search-bar input { background: none; border: none; color: white; font-size: 1.2rem; flex-grow: 1; outline: none; padding: 0.75rem 1rem; }
        #search-results h2 { margin-top: 1.5rem; margin-bottom: 1rem; }
        
        #page-profile h2, #page-profile h3 { text-align: center; margin-bottom: 1rem; }
        #page-profile h3 { font-weight: 400; color: #ccc; margin-bottom: 2rem; }
        .logout-button { background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 1rem; font-size: 1.2rem; font-weight: 700; cursor: pointer; width: 100%; max-width: 400px; display: block; margin: 4rem auto 0; }

        .device-selector { margin-top: 2rem; }
        .device-selector-title { text-align: center; font-weight: 500; color: #aaa; margin-bottom: 1rem; }
        .device-options { display: flex; justify-content: center; gap: 1rem; }
        .device-option { background-color: #333; color: #fff; padding: 0.75rem 1.5rem; border-radius: 5px; cursor: pointer; border: 2px solid transparent; }
        .device-option.active { border-color: var(--primary-color); background-color: rgba(229, 9, 20, 0.2); font-weight: 700; }

        @media (min-width: 768px) {
            .navbar-desktop { display: flex; }
            .navbar-mobile { display: none; }
            .media-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
            .generic-page { padding-top: 6rem; }
        }

        .tv-mode { font-size: 18px; cursor: none; }
        .tv-mode *:focus { outline: 4px solid #E50914 !important; box-shadow: 0 0 20px rgba(229, 9, 20, 0.7); transform: scale(1.08); z-index: 10; }
    </style>
</head>
<body>
    <div id="login-container" class="active">
        <div class="login-box">
            <h1>Entrar</h1>
            <form id="firebase-login-form" class="login-form">
                <input type="text" id="login-username" placeholder="Nome de Usuário" required autocomplete="username">
                <input type="password" id="login-password" placeholder="Senha" required autocomplete="current-password">
                <button type="submit">Entrar</button>
            </form>
            <div id="login-error"></div>
            <div class="loader-container" id="login-loader"><div class="loader"></div></div>
        </div>
    </div>

    <div class="app-wrapper">
        <header class="mobile-header"><h1 id="mobile-page-title">Início</h1></header>
        <div class="app-container">
            <nav class="navbar-desktop">
                <div class="logo">FAST</div>
                <ul class="nav-links">
                    <li class="nav-link" data-page="home"><a tabindex="0">Início</a></li>
                    <li class="nav-link" data-page="series"><a tabindex="0">Séries</a></li>
                    <li class="nav-link" data-page="movies"><a tabindex="0">Filmes</a></li>
                    <li class="nav-link" data-page="iptv"><a tabindex="0">Canais Ao Vivo</a></li>
                    <li class="nav-link" data-page="search"><a tabindex="0">Pesquisar</a></li>
                </ul>
                <div class="profile"> 
                    <img src="https://i.pravatar.cc/40" alt="Perfil" tabindex="0"> 
                    <div class="profile-menu">
                        <button class="nav-item" data-page="profile">Minha Conta</button>
                        <button id="logout-btn">Sair</button>
                    </div>
                </div>
            </nav>

            <main class="main-content">
                <div id="page-home" class="page"><div id="home-content"></div></div>
                <div id="page-series" class="page generic-page"><div id="series-content" class="media-grid"></div></div>
                <div id="page-movies" class="page generic-page"><div id="movies-content" class="media-grid"></div></div>
                <div id="page-iptv" class="page generic-page"><div id="iptv-content" class="media-grid"></div></div>
                <div id="page-search" class="page generic-page">
                    <div class="search-bar"><input type="text" id="search-input" placeholder="Buscar em todo o conteúdo..."></div>
                    <div id="search-results"></div>
                </div>
                <div id="page-series-details" class="page">
                    <div id="series-details-backdrop"></div>
                    <div id="series-details-info">
                        <h1 id="series-details-title"></h1>
                        <p id="series-details-plot"></p>
                        <div class="season-selector"><select id="season-select"></select></div>
                        <div id="episode-list"></div>
                    </div>
                </div>
                <div id="page-profile" class="page generic-page">
                    <h2>Perfil e Configurações</h2>
                    <h3>Gerencie suas preferências de visualização.</h3>
                    <div class="device-selector" id="profile-device-selector">
                        <div class="device-selector-title">Modo de Visualização:</div>
                        <div class="device-options">
                            <div class="device-option" data-device="computer" tabindex="0">Computador</div>
                            <div class="device-option" data-device="mobile" tabindex="0">Padrão (Celular)</div>
                            <div class="device-option" data-device="tv" tabindex="0">Televisão</div>
                        </div>
                    </div>
                    <button id="mobile-logout-btn" class="logout-button">Sair da Conta</button>
                </div>
            </main>

            <div id="page-player" class="page player-page">
                <button class="back-from-player"><svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"></path></svg></button>
                <video controls autoplay><source src=""></video>
            </div>

            <nav class="navbar-mobile">
                <button class="nav-item" data-page="home"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/home.png" alt="Início"/> <span>Início</span> </button>
                <button class="nav-item" data-page="series"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/tv-show.png" alt="Séries"/> <span>Séries</span> </button>
                <button class="nav-item" data-page="movies"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/movie-projector.png" alt="Filmes"/> <span>Filmes</span> </button>
                <button class="nav-item" data-page="iptv"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/playlist.png" alt="IPTV"/> <span>Ao Vivo</span> </button>
                <button class="nav-item" data-page="search"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/search.png" alt="Pesquisar"/> <span>Pesquisar</span> </button>
                <button class="nav-item" data-page="profile"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/user-male-circle.png" alt="Perfil"/> <span>Perfil</span> </button>
            </nav>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCY9sq12w7H9X3hm9FLa_KkazKONpm1nJE",
            authDomain: "fasthub-9a206.firebaseapp.com",
            databaseURL: "https://fasthub-9a206-default-rtdb.firebaseio.com",
            projectId: "fasthub-9a206",
            storageBucket: "fasthub-9a206.appspot.com",
            messagingSenderId: "685686875831",
            appId: "1:685686875831:web:035d9deb8596e4a3b88f32"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Set session persistence to LOCAL
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .catch(error => console.error("Error setting session persistence:", error));

        document.addEventListener('DOMContentLoaded', () => {
            const loginContainer = document.getElementById('login-container');
            const appWrapper = document.querySelector('.app-wrapper');
            const loginForm = document.getElementById('firebase-login-form');
            const loginError = document.getElementById('login-error');
            const loginLoader = document.getElementById('login-loader');
            const mainContent = document.querySelector('.main-content');
            const pages = document.querySelectorAll('.page');
            const desktopLinks = document.querySelectorAll('.navbar-desktop .nav-links .nav-link, .profile-menu .nav-item');
            const mobileLinks = document.querySelectorAll('.navbar-mobile .nav-item');
            const mobilePageTitle = document.getElementById('mobile-page-title');
            const backFromPlayerBtn = document.querySelector('.back-from-player');
            const videoPlayer = document.querySelector('#page-player video');
            const searchInput = document.getElementById('search-input');
            const searchResultsContainer = document.getElementById('search-results');

            let appData = { vodStreams: [], series: [], liveStreams: [] };
            let lastPageId = 'home';
            let hls = null;
            let currentUserData = null;

            // Initialize UI state
            loginContainer.classList.add('active');
            appWrapper.classList.remove('active');
            loginLoader.style.display = 'none';

            // --- Device Selection Logic ---
            function saveDevicePreference(device) {
                localStorage.setItem('device_preference', device);
            }

            function getDevicePreference() {
                return localStorage.getItem('device_preference');
            }

            function applyDeviceMode(device) {
                document.body.classList.remove('tv-mode');
                if (device === 'tv') document.body.classList.add('tv-mode');
                document.querySelectorAll('.device-option').forEach(opt => opt.classList.toggle('active', opt.dataset.device === device));
                saveDevicePreference(device);
            }

            function autoEnableTvMode() {
                if (!getDevicePreference()) applyDeviceMode('tv');
            }

            document.addEventListener('click', e => {
                if (e.target.closest('.device-option')) applyDeviceMode(e.target.closest('.device-option').dataset.device);
            });

            function initializeDeviceMode() {
                const preferredDevice = getDevicePreference();
                if (preferredDevice) applyDeviceMode(preferredDevice);
                else applyDeviceMode(window.matchMedia("(max-width: 768px)").matches ? 'mobile' : 'computer');
            }

            window.addEventListener('keydown', e => {
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) autoEnableTvMode();
            });

            auth.onAuthStateChanged(user => {
                console.log('Auth state changed:', user ? `User ${user.uid} logged in` : 'No user logged in');
                if (user) {
                    loginContainer.classList.remove('active');
                    appWrapper.classList.add('active');
                    loginLoader.style.display = 'none';
                    if (!currentUserData) loadContentForUser(user);
                } else {
                    loginContainer.classList.add('active');
                    appWrapper.classList.remove('active');
                    currentUserData = null;
                    appData = { vodStreams: [], series: [], liveStreams: [] };
                    loginLoader.style.display = 'none';
                }
            });

            loginForm.addEventListener('submit', e => {
                e.preventDefault();
                const username = document.getElementById('login-username').value.trim();
                const password = document.getElementById('login-password').value;
                const email = username + '@fast-iptv.user';

                loginLoader.style.display = 'block';
                loginError.textContent = '';

                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        loginLoader.style.display = 'none';
                    })
                    .catch(error => {
                        console.error('Login error:', error);
                        loginError.textContent = "Usuário ou senha inválidos.";
                        loginLoader.style.display = 'none';
                    });
            });

            // --- Fetch with Timeout ---
            async function fetchWithTimeout(resource, options = {}, timeout = 20000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try {
                    const response = await fetch(resource, { ...options, signal: controller.signal });
                    clearTimeout(id);
                    if (!response.ok) throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
                    return response;
                } catch (error) {
                    clearTimeout(id);
                    throw error;
                }
            }

            function proxifyUrl(url) {
                if (!url || typeof url !== 'string') return '';
                const PROXY_PREFIX = 'https://api.allorigins.win/raw?url=';
                if (url.startsWith('http://') || url.startsWith('https://')) {
                    if (url.includes('?url=')) return url;
                    return PROXY_PREFIX + encodeURIComponent(url);
                }
                return url;
            }

            async function loadContentForUser(user) {
                loginLoader.style.display = 'block';
                loginError.textContent = '';
                try {
                    const userRef = db.ref('fast-iptv/' + user.uid);
                    const snapshot = await userRef.once('value');
                    currentUserData = snapshot.val();

                    if (!currentUserData) {
                        throw new Error("Dados de configuração não encontrados para este usuário.");
                    }

                    const { xtreamUrl, xtreamUser, xtreamPass, m3uUrl } = currentUserData;
                    if (!xtreamUrl || !xtreamUser || !xtreamPass || !m3uUrl) {
                        throw new Error("Configuração incompleta no banco de dados.");
                    }

                    const proxiedM3uUrl = proxifyUrl(m3uUrl);

                    // Fetch M3U and Xtream data in parallel
                    const [liveStreamsResult, vodStreamsResult, seriesResult] = await Promise.all([
                        fetchWithTimeout(proxiedM3uUrl)
                            .then(res => res.text())
                            .then(text => parseM3U(text).live)
                            .catch(error => {
                                console.warn("Falha ao carregar M3U:", error.message);
                                return [];
                            }),
                        fetchXtreamData(xtreamUrl, xtreamUser, xtreamPass, 'get_vod_streams')
                            .catch(error => {
                                console.warn("Falha ao carregar VOD streams:", error.message);
                                return [];
                            }),
                        fetchXtreamData(xtreamUrl, xtreamUser, xtreamPass, 'get_series')
                            .catch(error => {
                                console.warn("Falha ao carregar séries:", error.message);
                                return [];
                            })
                    ]);

                    appData = {
                        liveStreams: liveStreamsResult || [],
                        vodStreams: vodStreamsResult || [],
                        series: seriesResult || []
                    };

                    renderAllPages();
                    showPage('home');
                } catch (error) {
                    console.error("Erro ao carregar conteúdo:", error);
                    loginError.textContent = `Erro: ${error.message}. Tente novamente ou verifique as configurações.`;
                } finally {
                    loginLoader.style.display = 'none';
                }
            }

            const logoutButtons = document.querySelectorAll('#logout-btn, #mobile-logout-btn');
            logoutButtons.forEach(btn => btn.addEventListener('click', () => {
                auth.signOut().then(() => {
                    console.log('User signed out');
                    loginContainer.classList.add('active');
                    appWrapper.classList.remove('active');
                    loginLoader.style.display = 'none';
                });
            }));

            function renderAllPages() {
                renderHomePage();
                renderGridPage('movies', appData.vodStreams);
                renderGridPage('series', appData.series);
                renderGridPage('iptv', appData.liveStreams);
            }

            function renderHomePage() {
                const homeContent = document.getElementById('home-content');
                const firstItem = appData.vodStreams?.[0] || appData.series?.[0] || appData.liveStreams?.[0];
                if (homeContent && firstItem) {
                    homeContent.innerHTML = `<header class="hero-section" style="background-image: linear-gradient(to top, #141414 10%, transparent 50%), url('${firstItem.stream_icon || firstItem.cover || ''}');"><div class="hero-content"><h1 class="hero-title">${firstItem.name}</h1></div></header>`;
                } else if (homeContent) {
                    homeContent.innerHTML = '<div class="generic-page"><h1>Bem-vindo!</h1><p>Nenhum conteúdo em destaque encontrado.</p></div>';
                }
            }

            function renderGridPage(pageId, items) {
                const container = document.getElementById(`${pageId}-content`);
                if (!container) return;
                container.innerHTML = '';
                if (!items || items.length === 0) {
                    container.innerHTML = `<p style="padding: 2rem;">Nenhum item encontrado nesta categoria.</p>`;
                    return;
                }
                const cardsHtml = items.map(item => createCardHtml(item, pageId)).join('');
                container.innerHTML = cardsHtml;
            }

            function createCardHtml(item, pageId) {
                const title = item.name || '';
                const image = item.stream_icon || item.cover || item.logo || '';
                let streamUrl = '';
                let seriesId = '';

                if (currentUserData) {
                    const { xtreamUrl, xtreamUser, xtreamPass } = currentUserData;
                    const streamId = item.stream_id || item.series_id;
                    if (pageId === 'movies') {
                        streamUrl = `${xtreamUrl}/movie/${xtreamUser}/${xtreamPass}/${streamId}.${item.container_extension || 'mp4'}`;
                    } else if (pageId === 'iptv') {
                        streamUrl = item.url;
                    } else if (pageId === 'series') {
                        seriesId = streamId;
                    }
                }

                return `<div class="media-card" tabindex="0" data-stream-url="${streamUrl || ''}" data-series-id="${seriesId || ''}">
                            <img src="${image}" alt="${title}" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/400x600/222/fff?text=${encodeURIComponent(title)}';">
                            <div class="media-card-title">${title}</div>
                        </div>`;
            }

            mainContent.addEventListener('click', (event) => {
                const card = event.target.closest('.media-card, .episode-item');
                if (!card) return;
                if (card.dataset.seriesId) {
                    renderSeriesDetailsPage(card.dataset.seriesId);
                } else if (card.dataset.streamUrl) {
                    const url = card.dataset.streamUrl;
                    openPlayer(proxifyUrl(url));
                }
            });

            async function renderSeriesDetailsPage(seriesId) {
                const { xtreamUrl, xtreamUser, xtreamPass } = currentUserData;
                const seriesInfo = await fetchXtreamData(xtreamUrl, xtreamUser, xtreamPass, `get_series_info&series_id=${seriesId}`)
                    .catch(error => {
                        console.warn("Falha ao carregar detalhes da série:", error.message);
                        return null;
                    });

                if (!seriesInfo || !seriesInfo.info) {
                    alert("Não foi possível carregar os detalhes da série.");
                    return;
                }

                document.getElementById('series-details-backdrop').style.backgroundImage = `url('${seriesInfo.info.backdrop_path?.[0] || ''}')`;
                document.getElementById('series-details-title').textContent = seriesInfo.info.name || 'Sem título';
                document.getElementById('series-details-plot').textContent = seriesInfo.info.plot || 'Sem descrição disponível';

                const seasonSelect = document.getElementById('season-select');
                const episodeList = document.getElementById('episode-list');
                seasonSelect.innerHTML = '';
                episodeList.innerHTML = '';

                if (seriesInfo.episodes) {
                    Object.keys(seriesInfo.episodes).forEach(seasonNum => seasonSelect.add(new Option(`Temporada ${seasonNum}`, seasonNum)));
                    const renderEpisodes = (seasonNum) => {
                        episodeList.innerHTML = '';
                        seriesInfo.episodes[seasonNum].forEach(ep => {
                            const epUrl = `${xtreamUrl}/series/${xtreamUser}/${xtreamPass}/${ep.id}.${ep.container_extension || 'mp4'}`;
                            episodeList.innerHTML += `<div class="episode-item" tabindex="0" data-stream-url="${epUrl}">
                                <img src="${ep.info.movie_image || ''}" onerror="this.style.display='none'">
                                <div><strong>${ep.episode_num}. ${ep.title || 'Episódio sem título'}</strong><p>${ep.info.plot || ''}</p></div>
                            </div>`;
                        });
                    };
                    seasonSelect.onchange = () => renderEpisodes(seasonSelect.value);
                    renderEpisodes(Object.keys(seriesInfo.episodes)[0]);
                }
                showPage('series-details');
            }

            function openPlayer(streamUrl) {
                if (!streamUrl || streamUrl === 'null') {
                    alert("URL de streaming inválida.");
                    return;
                }
                showPage('player');
                if (hls) {
                    hls.destroy();
                    hls = null;
                }

                try {
                    if (Hls.isSupported()) {
                        hls = new Hls();
                        hls.loadSource(streamUrl);
                        hls.attachMedia(videoPlayer);
                        hls.on(Hls.Events.ERROR, (event, data) => {
                            console.error("HLS Error:", data);
                            alert("Erro ao carregar o stream. Verifique a conexão ou a URL.");
                            showPage(lastPageId);
                        });
                    } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                        videoPlayer.src = streamUrl;
                        videoPlayer.addEventListener('error', () => {
                            console.error("Video Player Error:", videoPlayer.error);
                            alert("Erro ao reproduzir o vídeo.");
                            showPage(lastPageId);
                        });
                    } else {
                        alert("Seu navegador não suporta streaming HLS.");
                        showPage(lastPageId);
                    }
                } catch (error) {
                    console.error("Player Error:", error);
                    alert("Erro ao iniciar o player.");
                    showPage(lastPageId);
                }
            }

            backFromPlayerBtn.addEventListener('click', () => {
                showPage(lastPageId);
                videoPlayer.pause();
                videoPlayer.removeAttribute('src');
                if (hls) {
                    hls.destroy();
                    hls = null;
                }
            });

            async function fetchXtreamData(baseUrl, user, pass, action) {
                const finalUrl = `${baseUrl}/player_api.php?username=${user}&password=${pass}&action=${action}`;
                const proxiedUrl = proxifyUrl(finalUrl);
                try {
                    const response = await fetchWithTimeout(proxiedUrl);
                    const data = await response.json();
                    if (!data || (Array.isArray(data) && data.length === 0)) {
                        throw new Error(`Resposta vazia ou inválida para ${action}`);
                    }
                    return data;
                } catch (e) {
                    throw new Error(`Falha ao buscar dados de ${action}: ${e.message}`);
                }
            }

            function parseM3U(text) {
                const lines = text.split('\n');
                const result = { live: [] };
                let currentItem = {};
                for (const line of lines) {
                    if (line.startsWith('#EXTINF:')) {
                        const commaIndex = line.lastIndexOf(',');
                        const title = commaIndex !== -1 ? line.substring(commaIndex + 1).trim() : '';
                        const getAttribute = (attr, str) => {
                            const match = str.match(new RegExp(`${attr}="([^"]*)"`));
                            return match ? match[1] : null;
                        };
                        currentItem = { name: getAttribute('tvg-name', line) || title, logo: getAttribute('tvg-logo', line) };
                    } else if (line.trim() && !line.startsWith('#')) {
                        currentItem.url = line.trim();
                        result.live.push(currentItem);
                        currentItem = {};
                    }
                }
                return result;
            }

            function showPage(pageId) {
                if (pageId !== 'player' && pageId !== 'series-details') lastPageId = pageId;
                pages.forEach(page => page.classList.remove('active'));
                const newPage = document.getElementById(`page-${pageId}`);
                if (newPage) {
                    newPage.classList.add('active');
                    mobilePageTitle.textContent = {
                        'home': 'Início',
                        'series': 'Séries',
                        'movies': 'Filmes',
                        'iptv': 'Canais Ao Vivo',
                        'search': 'Pesquisar',
                        'profile': 'Perfil',
                        'series-details': 'Detalhes da Série',
                        'player': 'Player'
                    }[pageId] || 'Página';
                }
            }

            [...desktopLinks, ...mobileLinks].forEach(link => {
                const pageId = link.dataset.page;
                if (pageId) link.addEventListener('click', e => {
                    e.preventDefault();
                    showPage(pageId);
                });
            });

            initializeDeviceMode();
        });
    </script>
</body>
</html>
