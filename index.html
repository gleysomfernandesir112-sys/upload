<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Streaming Layout - Login Xtream</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --primary-color: #E50914;
            --background-color: #141414;
            --text-color: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            overflow-x: hidden;
            padding-top: 60px; /* Espa√ßo para header mobile */
        }
        
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://image.tmdb.org/t/p/original/VlHt2blBkncfAqPnuTtraG2flp.jpg') no-repeat center center/cover; }
        .app-wrapper { display: none; }
        .app-container { width: 100%; min-height: 100vh; padding-bottom: 80px; }
        
        .login-box { background-color: rgba(0,0,0,0.85); padding: 4rem; border-radius: 8px; max-width: 450px; width: 100%; }
        .login-box h1 { text-align: center; margin-bottom: 2rem; }
        .login-tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 1px solid #333; }
        .login-tab { flex: 1; text-align: center; padding: 0.75rem; cursor: pointer; border-bottom: 3px solid transparent; }
        .login-tab.active { border-bottom-color: var(--primary-color); }
        .login-form { display: none; flex-direction: column; gap: 1rem; }
        .login-form.active { display: flex; }
        .login-form input { background-color: #333; border: none; border-radius: 5px; color: white; padding: 1rem; font-size: 1rem; }
        .login-form button { background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 1rem; font-size: 1.2rem; font-weight: 700; cursor: pointer; margin-top: 1.5rem; }
        #login-error { color: #e87c03; margin-top: 1rem; text-align: center; min-height: 1.2em; }

        .page { display: none; animation: fadeIn 0.4s ease-in-out; }
        .page.active { display: block; }
        .player-page.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mobile-header {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 101;
            padding: 1rem 1rem 0.75rem;
            padding-top: env(safe-area-inset-top, 1rem);
            border-bottom: 1px solid #333;
        }
        .mobile-header h1 { font-size: 1.2rem; font-weight: 500; }

        .navbar-desktop { display: none; position: fixed; top: 0; width: 100%; padding: 1rem 3rem; background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%); align-items: center; z-index: 100; transition: background-color 0.3s; }
        .navbar-desktop .logo { color: var(--primary-color); font-size: 1.8rem; font-weight: 700; margin-right: 2rem; }
        .navbar-desktop .nav-links { list-style: none; display: flex; gap: 1.5rem; flex-grow: 1; align-items: center; }
        .nav-link a { color: var(--text-color); text-decoration: none; font-size: 1rem; transition: color 0.2s; cursor: pointer; }
        .nav-link a:hover, .nav-link a.active { color: #b3b3b3; font-weight: 700; }
        .profile { position: relative; margin-left: auto; }
        .profile img { border-radius: 50%; width: 40px; height: 40px; cursor: pointer; }
        .profile-menu { display: none; position: absolute; right: 0; top: 50px; background-color: #181818; border-radius: 5px; overflow: hidden; }
        .profile:hover .profile-menu { display: block; }
        .profile-menu button { background: none; border: none; color: white; padding: 0.75rem 1.5rem; cursor: pointer; width: 100%; text-align: left; }
        .profile-menu button:hover { background-color: #333; }

        .hero-section { height: 60vh; display: flex; flex-direction: column; justify-content: center; padding: 0 5%; position: relative; background-size: cover; background-position: center center; }
        .hero-content { max-width: 500px; position: relative; z-index: 2; }
        .hero-title { font-size: 2.5rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 5px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-right: 1rem; transition: background-color 0.2s; }
        
        .media-card { flex: 0 0 150px; aspect-ratio: 10 / 16; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.3s ease; background-color: #222; display: flex; align-items: center; justify-content: center; text-align: center; position: relative; }
        .media-card img { width: 100%; height: 100%; object-fit: cover; }
        .media-card:hover { transform: scale(1.05); }
        .media-card-title { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); font-size: 0.8rem; padding: 5px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }

        .generic-page { padding: 1rem 5%; }
        .loader-container { display: none; text-align: center; padding: 2rem; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .load-sentinel { height: 40px; width: 100%; }
        
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .media-grid .media-card { flex-basis: auto; }

        .player-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 200; display: none; align-items: center; justify-content: center; }
        .player-page video { max-width: 100%; max-height: 100%; outline: none; }
        .back-from-player { position: absolute; top: 2rem; left: 2rem; background: rgba(0,0,0,0.5); border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .back-from-player svg { width: 25px; height: 25px; fill: white; }

        #series-details-backdrop { height: 60vh; background-size: cover; background-position: center top; position: relative; }
        #series-details-backdrop::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, var(--background-color) 10%, transparent 50%); }
        #series-details-info { padding: 2rem 5%; margin-top: -10vh; position: relative; z-index: 2; }
        #series-details-info h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        #series-details-plot { margin-bottom: 1.5rem; color: #ccc; }
        .season-selector { margin-bottom: 2rem; }
        .season-selector select { background: #333; color: white; padding: 0.5rem 1rem; border-radius: 5px; border: 1px solid #555; font-size: 1rem; }
        .episode-list { display: flex; flex-direction: column; gap: 1rem; }
        .episode-item { display: flex; align-items: center; gap: 1rem; background: #222; padding: 1rem; border-radius: 5px; cursor: pointer; }
        .episode-item:hover { background: #333; }
        .episode-item img { width: 150px; height: 84px; object-fit: cover; border-radius: 3px; }

        .navbar-mobile { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background-color: rgba(20, 20, 20, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; z-index: 100; border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { background: none; border: none; color: #8e8e8e; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; cursor: pointer; transition: color 0.2s; flex-grow: 1; }
        .nav-item img { width: 24px; height: 24px; filter: invert(58%); }
        .nav-item.active { color: var(--text-color); }
        .nav-item.active img { filter: none; }
        
        /* Search */
        #page-search { padding: 1rem 5%; }
        .search-bar { display: flex; align-items: stretch; background-color: #333; border-radius: 5px; margin-bottom: 2rem; }
        .search-bar input { background: none; border: none; color: white; font-size: 1.2rem; flex-grow: 1; outline: none; padding: 0.75rem 1rem; }
        #search-results h2 { margin-top: 1.5rem; margin-bottom: 1rem; }
        
        /* Profile Page & Logout Button */
        #page-profile h2 {
            margin-bottom: 2rem;
            text-align: center;
            font-size: 1.5rem;
        }
        .logout-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            max-width: 400px;
            display: block;
            margin: 2rem auto 0;
        }
        .logout-button:hover {
            background-color: #f40612;
        }

        @media (min-width: 768px) {
            body { padding-top: 0; }
            .mobile-header { display: none; }
            .app-container { padding-bottom: 0; }
            .navbar-desktop { display: flex; }
            .navbar-mobile { display: none; }
            .hero-section, #series-details-backdrop { height: 80vh; }
            .hero-title, #series-details-info h1 { font-size: 3.5rem; }
            .media-card { flex-basis: 220px; }
            .media-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
            .generic-page { padding-top: 6rem; }
            #page-search { padding-top: 6rem; }
        }
    </style>
</head>
<body>
    <div id="login-container">
        <div class="login-box">
            <h1>Entrar</h1>
            <div class="login-tabs">
                <div class="login-tab active" data-form="xtream">API Xtream Codes</div>
                <div class="login-tab" data-form="m3u">Lista M3U</div>
            </div>
            <form id="xtream-form" class="login-form active">
                <input type="text" id="xtream-url" placeholder="URL do Servidor (ex: http://domain.com:port)" required>
                <input type="text" id="xtream-user" placeholder="Utilizador" required>
                <input type="password" id="xtream-pass" placeholder="Palavra-passe" required>
                <button type="submit">Entrar</button>
            </form>
            <form id="m3u-form" class="login-form">
                <input type="url" id="m3u-url-input" placeholder="URL da lista M3U" required>
                <button type="submit">Carregar Lista</button>
            </form>
            <div id="login-error"></div>
             <div class="loader-container" id="login-loader">
                <div class="loader"></div>
            </div>
        </div>
    </div>

    <div class="app-wrapper">
        <header class="mobile-header">
            <h1 id="mobile-page-title">In√≠cio</h1>
        </header>
        <div class="app-container">
            <nav class="navbar-desktop">
                <div class="logo">STREAMFLIX</div>
                <ul class="nav-links">
                    <li class="nav-link" data-page="home"><a >In√≠cio</a></li>
                    <li class="nav-link" data-page="series"><a >S√©ries</a></li>
                    <li class="nav-link" data-page="movies"><a >Filmes</a></li>
                    <li class="nav-link" data-page="iptv"><a>Canais Ao Vivo</a></li>
                    <li class="nav-link" data-page="search"><a>Pesquisar</a></li>
                </ul>
                <div class="profile"> 
                    <img src="https://i.pravatar.cc/40" alt="Perfil"> 
                    <div class="profile-menu">
                        <button id="logout-btn">Sair</button>
                    </div>
                </div>
            </nav>

            <main class="main-content">
                <div id="page-home" class="page"><div id="home-content"></div></div>
                <div id="page-series" class="page generic-page"><div id="series-content" class="media-grid"></div></div>
                <div id="page-movies" class="page generic-page"><div id="movies-content" class="media-grid"></div></div>
                <div id="page-iptv" class="page generic-page"><div id="iptv-content" class="media-grid"></div></div>
                <div id="page-search" class="page generic-page">
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Buscar em todo o conte√∫do...">
                    </div>
                    <div id="search-results"></div>
                </div>
                <div id="page-series-details" class="page">
                    <div id="series-details-backdrop"></div>
                    <div id="series-details-info">
                        <h1 id="series-details-title"></h1>
                        <p id="series-details-plot"></p>
                        <div class="season-selector">
                            <select id="season-select"></select>
                        </div>
                        <div id="episode-list"></div>
                    </div>
                </div>
                <div id="page-profile" class="page generic-page">
                    <h2>Perfil e Configura√ß√µes</h2>
                    <button id="mobile-logout-btn" class="logout-button">Sair da Conta</button>
                </div>
            </main>

            <div id="page-player" class="page player-page">
                <button class="back-from-player">
                    <svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"></path></svg>
                </button>
                <video controls autoplay><source src="" type="video/mp4"></video>
            </div>

            <nav class="navbar-mobile">
                <button class="nav-item" data-page="home"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/home.png" alt="In√≠cio"/> <span>In√≠cio</span> </button>
                <button class="nav-item" data-page="series"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/tv-show.png" alt="S√©ries"/> <span>S√©ries</span> </button>
                <button class="nav-item" data-page="movies"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/movie-projector.png" alt="Filmes"/> <span>Filmes</span> </button>
                <button class="nav-item" data-page="iptv"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/playlist.png" alt="IPTV"/> <span>Ao Vivo</span> </button>
                <button class="nav-item" data-page="search"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/search.png" alt="Pesquisar"/> <span>Pesquisar</span> </button>
                <button class="nav-item" data-page="profile"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/user-male-circle.png" alt="Perfil"/> <span>Perfil</span> </button>
            </nav>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginContainer = document.getElementById('login-container');
            const appWrapper = document.querySelector('.app-wrapper');
            const mainContent = document.querySelector('.main-content');
            const pages = document.querySelectorAll('.page');
            const desktopLinks = document.querySelectorAll('.navbar-desktop .nav-links .nav-link');
            const mobileLinks = document.querySelectorAll('.navbar-mobile .nav-item');
            const mobilePageTitle = document.getElementById('mobile-page-title');
            const backFromPlayerBtn = document.querySelector('.back-from-player');
            const videoPlayer = document.querySelector('#page-player video');
            const videoSource = videoPlayer.querySelector('source');
            const logoutBtn = document.getElementById('logout-btn');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
            const loginTabs = document.querySelectorAll('.login-tab');
            const loginForms = document.querySelectorAll('.login-form');
            const xtreamForm = document.getElementById('xtream-form');
            const m3uForm = document.getElementById('m3u-form');
            const loginError = document.getElementById('login-error');
            const loginLoader = document.getElementById('login-loader');
            const searchInput = document.getElementById('search-input');
            const searchResultsContainer = document.getElementById('search-results');
            
            let lastPageId = 'home';
            let activeUser = null;
            let appData = { vodStreams: [], series: [], liveStreams: [] };
            let renderState = {};
            const RENDER_BATCH_SIZE = 100;
            let lazyLoadObserver;
            let searchTimeout;
            let hls = null;

            function showLoginError(message) {
                loginError.textContent = message;
                loginLoader.style.display = 'none';
            }

            function showApp(loginType) {
                loginContainer.style.display = 'none';
                appWrapper.style.display = 'block';
                updateNavigation();
                const startPage = (loginType === 'm3u' && appData.vodStreams.length === 0 && appData.series.length === 0) ? 'iptv' : 'home';
                showPage(startPage);
            }

            function initializeLazyLoader() {
                if (lazyLoadObserver) lazyLoadObserver.disconnect();
                const options = { root: null, rootMargin: '0px 0px 500px 0px', threshold: 0 };
                lazyLoadObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const sentinel = entry.target;
                            const { stateKey, pageId } = sentinel.dataset;
                            loadMoreItems(document.getElementById(`${pageId}-content`), sentinel, stateKey, pageId, observer);
                        }
                    });
                }, options);
            }
            
            async function fetchAPI(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response;
                } catch (error) {
                    if (error instanceof TypeError) throw new Error(`Falha na rede ou erro de CORS.`);
                    throw error;
                }
            }


            async function fetchXtreamData(url, user, pass, action) {
                const targetUrl = `${url}/player_api.php?username=${user}&password=${pass}&action=${action}`;
                const response = await fetchAPI(targetUrl);
                const textData = await response.text();
                try {
                    if (textData.trim() === '[]') return [];
                    const data = JSON.parse(textData);
                    if (data.user_info && data.user_info.auth === 0) throw new Error('Credenciais inv√°lidas.');
                    return data;
                } catch(e) {
                    throw new Error('Resposta inv√°lida do servidor (n√£o √© JSON).');
                }
            }

            async function loginWithXtream(url, user, pass) {
                loginLoader.style.display = 'block';
                loginError.textContent = '';
                try {
                    await fetchXtreamData(url, user, pass, 'get_user_info');
                    const [liveStreams, vodStreams, series] = await Promise.all([
                        fetchXtreamData(url, user, pass, 'get_live_streams'),
                        fetchXtreamData(url, user, pass, 'get_vod_streams'),
                        fetchXtreamData(url, user, pass, 'get_series'),
                    ]);
                    appData = { liveStreams, vodStreams, series };
                    activeUser = { type: 'xtream', url, user, pass };
                    localStorage.setItem('streamflix_session', JSON.stringify(activeUser));
                    renderAllPages();
                    showApp('xtream');
                } catch (error) {
                    showLoginError(error.message || 'Falha ao carregar dados.');
                } finally {
                    loginLoader.style.display = 'none';
                }
            }

            async function loginWithM3U(url) {
                loginLoader.style.display = 'block';
                loginError.textContent = '';
                try {
                    const response = await fetchAPI(url);
                    const m3uText = await response.text();
                    const content = parseM3U(m3uText);
                    if (content.live.length === 0 && content.vod.length === 0 && content.series.length === 0) throw new Error('Nenhum conte√∫do v√°lido encontrado na lista M3U.');
                    appData = { liveStreams: content.live, vodStreams: content.vod, series: content.series };
                    activeUser = { type: 'm3u', url };
                    localStorage.setItem('streamflix_session', JSON.stringify(activeUser));
                    renderAllPages();
                    showApp('m3u');
                } catch (error) {
                    showLoginError(error.message);
                } finally {
                    loginLoader.style.display = 'none';
                }
            }
            
            function renderAllPages() {
                renderState = {};
                initializeLazyLoader();
                renderHomePage();
                renderGridPage('movies', appData.vodStreams);
                renderGridPage('series', appData.series);
                renderGridPage('iptv', appData.liveStreams);
            }

            function renderHomePage() {
                const homeContent = document.getElementById('home-content');
                const firstItem = appData.vodStreams?.[0] || appData.series?.[0] || appData.liveStreams?.[0];
                if (!firstItem) {
                    homeContent.innerHTML = '<div class="generic-page"><h1>Bem-vindo!</h1><p>Navegue pelas se√ß√µes para encontrar conte√∫do.</p></div>';
                    return;
                }
                const title = firstItem.name;
                const image = firstItem.stream_icon || firstItem.cover;
                homeContent.innerHTML = `
                    <header class="hero-section" style="background-image: linear-gradient(to top, #141414 10%, transparent 50%), url('${image}');">
                        <div class="hero-content">
                            <h1 class="hero-title">${title}</h1>
                        </div>
                    </header>
                `;
            }

            function renderGridPage(pageId, items) {
                const container = document.getElementById(`${pageId}-content`);
                container.innerHTML = '';
                if (!items || items.length === 0) return;
                
                const sentinel = document.createElement('div');
                sentinel.className = 'load-sentinel';
                container.after(sentinel);
                
                const stateKey = `${pageId}-grid`;
                renderState[stateKey] = { items: items, nextIndex: 0 };
                
                sentinel.dataset.stateKey = stateKey;
                sentinel.dataset.pageId = pageId;

                lazyLoadObserver.observe(sentinel);
            }

            function loadMoreItems(container, sentinel, stateKey, pageId, observer) {
                const state = renderState[stateKey];
                if (!state) return;
                observer.unobserve(sentinel);

                const itemsToRender = state.items.slice(state.nextIndex, state.nextIndex + RENDER_BATCH_SIZE);
                let cardsHtml = '';
                itemsToRender.forEach(item => {
                    cardsHtml += createCardHtml(item, pageId);
                });

                container.insertAdjacentHTML('beforeend', cardsHtml);
                state.nextIndex += itemsToRender.length;
                
                if (state.nextIndex < state.items.length) {
                    observer.observe(sentinel);
                } else {
                    sentinel.remove();
                }
            }

            function createCardHtml(item, pageId) {
                const streamId = item.stream_id || item.series_id;
                const title = item.name;
                const image = item.stream_icon || item.cover || item.logo;
                let streamUrl = '';
                let seriesId = '';
                
                if (activeUser.type === 'xtream') {
                    streamUrl = pageId === 'movies' ? `${activeUser.url}/movie/${activeUser.user}/${activeUser.pass}/${streamId}.${item.container_extension}` : (pageId === 'iptv' ? `${activeUser.url}/live/${activeUser.user}/${activeUser.pass}/${streamId}.ts` : '');
                    seriesId = pageId === 'series' ? streamId : '';
                } else { // M3U
                    if (pageId === 'series') {
                        seriesId = item.name;
                    } else {
                        streamUrl = item.url;
                    }
                }

                return `
                    <div class="media-card" data-stream-url="${streamUrl}" data-series-id="${seriesId}">
                        <img src="${image}" alt="${title}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/222/fff?text=${encodeURIComponent(title)}';">
                        <div class="media-card-title">${title}</div>
                    </div>`;
            }

            function performSearch(query) {
                if (!query) {
                    searchResultsContainer.innerHTML = '';
                    return;
                }
                const lowerQuery = query.toLowerCase();
                const results = {
                    Filmes: appData.vodStreams.filter(i => i.name.toLowerCase().includes(lowerQuery)),
                    S√©ries: appData.series.filter(i => i.name.toLowerCase().includes(lowerQuery)),
                    "Canais Ao Vivo": appData.liveStreams.filter(i => i.name.toLowerCase().includes(lowerQuery)),
                };
                
                searchResultsContainer.innerHTML = '';
                for (const [category, items] of Object.entries(results)) {
                    if (items.length > 0) {
                        let cardsHtml = items.map(item => {
                            const pageId = category === 'Filmes' ? 'movies' : (category === 'S√©ries' ? 'series' : 'iptv');
                            return createCardHtml(item, pageId);
                        }).join('');
                        searchResultsContainer.innerHTML += `<h2>${category} (${items.length})</h2><div class="media-grid">${cardsHtml}</div>`;
                    }
                }
                if (searchResultsContainer.innerHTML === '') {
                    searchResultsContainer.innerHTML = `<p>Nenhum resultado encontrado para "${query}"</p>`;
                }
            }
            
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(searchInput.value);
                }, 300);
            });


            async function renderSeriesDetailsPage(seriesId) {
                try {
                    const seriesInfo = await fetchXtreamData(activeUser.url, activeUser.user, activeUser.pass, `get_series_info&series_id=${seriesId}`);
                    
                    document.getElementById('series-details-backdrop').style.backgroundImage = `url('${seriesInfo.info.backdrop_path?.[0] || ''}')`;
                    document.getElementById('series-details-title').textContent = seriesInfo.info.name;
                    document.getElementById('series-details-plot').textContent = seriesInfo.info.plot;
                    
                    const seasonSelect = document.getElementById('season-select');
                    seasonSelect.innerHTML = '';
                    if (seriesInfo.episodes) {
                        Object.keys(seriesInfo.episodes).forEach(seasonNum => {
                            const option = document.createElement('option');
                            option.value = seasonNum;
                            option.textContent = `Temporada ${seasonNum}`;
                            seasonSelect.appendChild(option);
                        });

                        const renderEpisodes = (seasonNum) => {
                            const episodeList = document.getElementById('episode-list');
                            episodeList.innerHTML = '';
                            seriesInfo.episodes[seasonNum].forEach(ep => {
                                const epUrl = `${activeUser.url}/series/${activeUser.user}/${activeUser.pass}/${ep.id}.${ep.container_extension}`;
                                const item = document.createElement('div');
                                item.className = 'episode-item';
                                item.dataset.streamUrl = epUrl;
                                item.innerHTML = `
                                    <img src="${ep.info.movie_image}" onerror="this.onerror=null;this.style.display='none';">
                                    <div>
                                        <strong>${ep.episode_num}. ${ep.title}</strong>
                                        <p>${ep.info.plot || ''}</p>
                                    </div>
                                `;
                                episodeList.appendChild(item);
                            });
                        };

                        seasonSelect.onchange = () => renderEpisodes(seasonSelect.value);
                        renderEpisodes(Object.keys(seriesInfo.episodes)[0]);
                    }
                    showPage('series-details');
                } catch (error) {
                    console.error('Error fetching series details:', error);
                }
            }

            async function renderM3USeriesDetailsPage(seriesName) {
                const seriesData = appData.series.find(s => s.name === seriesName);
                if (!seriesData) return;

                document.getElementById('series-details-backdrop').style.backgroundImage = `url('${seriesData.cover || ''}')`;
                document.getElementById('series-details-title').textContent = seriesData.name;
                document.getElementById('series-details-plot').textContent = '';

                const seasonSelect = document.getElementById('season-select');
                seasonSelect.innerHTML = '';
                
                const seasons = {};
                seriesData.episodes.forEach(ep => {
                    if (!seasons[ep.season]) {
                        seasons[ep.season] = [];
                    }
                    seasons[ep.season].push(ep);
                });

                Object.keys(seasons).sort((a, b) => a - b).forEach(seasonNum => {
                    const option = document.createElement('option');
                    option.value = seasonNum;
                    option.textContent = `Temporada ${seasonNum}`;
                    seasonSelect.appendChild(option);
                });

                const renderEpisodes = (seasonNum) => {
                    const episodeList = document.getElementById('episode-list');
                    episodeList.innerHTML = '';
                    if (!seasons[seasonNum]) return;
                    
                    seasons[seasonNum].sort((a,b) => a.episode - b.episode).forEach(ep => {
                        const item = document.createElement('div');
                        item.className = 'episode-item';
                        item.dataset.streamUrl = ep.url;
                        item.innerHTML = `
                            <img src="${ep.logo || seriesData.cover}" onerror="this.onerror=null;this.style.display='none';">
                            <div>
                                <strong>Epis√≥dio ${ep.episode}</strong>
                                <p>${ep.title}</p>
                            </div>
                        `;
                        episodeList.appendChild(item);
                    });
                };

                seasonSelect.onchange = () => renderEpisodes(seasonSelect.value);
                if (Object.keys(seasons).length > 0) {
                    renderEpisodes(Object.keys(seasons)[0]);
                }
                
                showPage('series-details');
            }


            function logout() {
                localStorage.removeItem('streamflix_session');
                activeUser = null;
                window.location.reload();
            }

            async function checkSession() {
                const session = localStorage.getItem('streamflix_session');
                if (session) {
                    const userData = JSON.parse(session);
                    if (userData.type === 'xtream') {
                        await loginWithXtream(userData.url, userData.user, userData.pass);
                    } else if (userData.type === 'm3u') {
                        await loginWithM3U(userData.url);
                    }
                }
            }

            function showPage(pageId) {
                if (pageId !== 'player' && pageId !== 'series-details') lastPageId = pageId;
                pages.forEach(page => page.classList.remove('active'));
                const newPage = document.getElementById(`page-${pageId}`);
                if (newPage) newPage.classList.add('active');

                const titleMap = {
                    home: 'In√≠cio',
                    series: 'S√©ries',
                    movies: 'Filmes',
                    iptv: 'Canais Ao Vivo',
                    search: 'Pesquisar',
                    profile: 'Perfil'
                };
                mobilePageTitle.textContent = titleMap[pageId] || 'In√≠cio';


                if (pageId !== 'player') {
                    window.scrollTo(0, 0);
                    desktopLinks.forEach(link => {
                        link.querySelector('a').classList.toggle('active', link.dataset.page === pageId);
                    });
                    mobileLinks.forEach(link => {
                         link.classList.toggle('active', link.dataset.page === pageId)
                    });
                }
            }

             function updateNavigation() {
                const navLinks = [...desktopLinks, ...mobileLinks];
                navLinks.forEach(link => {
                    const page = link.dataset.page;
                    let shouldShow = true; // Mostra todos por padr√£o agora
                    link.style.display = shouldShow ? '' : 'none';
                });
             }

            [...desktopLinks, ...mobileLinks].forEach(link => {
                const pageId = link.dataset.page;
                const target = link.tagName === 'LI' ? link.querySelector('a') : link;
                target.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(pageId);
                });
            });

            function openPlayer(streamUrl) {
                if (!streamUrl) return;

                if (hls) {
                    hls.destroy();
                    hls = null;
                }

                const isHls = streamUrl.includes('.m3u8') || streamUrl.includes('.ts');

                if (isHls && Hls.isSupported()) {
                    hls = new Hls();
                    hls.loadSource(streamUrl);
                    hls.attachMedia(videoPlayer);
                } else {
                    videoPlayer.src = streamUrl;
                }
                
                videoPlayer.load();
                showPage('player');
                videoPlayer.play();
            }
            
            mainContent.addEventListener('click', (event) => {
                const card = event.target.closest('.media-card, .episode-item');
                if (!card) return;
                
                if (card.dataset.seriesId) {
                    if (activeUser.type === 'xtream') {
                        renderSeriesDetailsPage(card.dataset.seriesId);
                    } else {
                        renderM3USeriesDetailsPage(card.dataset.seriesId);
                    }
                } else if (card.dataset.streamUrl) {
                    openPlayer(card.dataset.streamUrl);
                }
            });

            backFromPlayerBtn.addEventListener('click', () => {
                const isSeriesDetailsActive = document.getElementById('page-series-details').classList.contains('active');
                showPage(isSeriesDetailsActive ? 'series-details' : lastPageId);
                
                videoPlayer.pause();
                videoPlayer.removeAttribute('src');
                videoSource.setAttribute('src', '');

                if (hls) {
                    hls.destroy();
                    hls = null;
                }
                videoPlayer.load();
            });

            loginTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    loginTabs.forEach(t => t.classList.remove('active'));
                    loginForms.forEach(f => f.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.form + '-form').classList.add('active');
                    loginError.textContent = '';
                });
            });

            xtreamForm.addEventListener('submit', (e) => {
                e.preventDefault();
                loginWithXtream(
                    document.getElementById('xtream-url').value.trim(),
                    document.getElementById('xtream-user').value.trim(),
                    document.getElementById('xtream-pass').value.trim()
                );
            });
            
            m3uForm.addEventListener('submit', (e) => {
                e.preventDefault();
                loginWithM3U(document.getElementById('m3u-url-input').value.trim());
            });

             function parseM3U(text) {
                const lines = text.split('\n');
                const result = { live: [], vod: [], series: [] };
                const seriesMap = new Map();
                let currentItem = {};

                for (const line of lines) {
                    if (line.startsWith('#EXTINF:')) {
                        const commaIndex = line.lastIndexOf(',');
                        const title = commaIndex !== -1 ? line.substring(commaIndex + 1).trim() : '';
                        const infoLine = commaIndex !== -1 ? line.substring(0, commaIndex) : line;

                        const getAttribute = (attr, str) => {
                            const match = str.match(new RegExp(`${attr}="([^"]*)"`));
                            return match ? match[1].replace(/"/g, '') : null;
                        };
                        
                        currentItem = {
                            name: getAttribute('tvg-name', infoLine) || title,
                            logo: getAttribute('tvg-logo', infoLine),
                            group: getAttribute('group-title', infoLine) || 'Geral',
                            raw_title: title
                        };
                    } else if (line.trim() && !line.startsWith('#')) {
                        const url = line.trim();
                        currentItem.url = url;
                        if (!currentItem.name || !currentItem.url) {
                            currentItem = {}; continue;
                        }

                        const seriesMatch = currentItem.raw_title.match(/^(.*?)(?:[ ._-]S(\d+)[ ._-]?E(\d+)|[ ._-](\d+)¬™ Temporada[ ._-]Epis√≥dio (\d+))/i);
                        const isLive = url.includes('.ts') || url.includes('/live/') || !(/\.(mp4|mkv|avi)$/i.test(url));
                        
                        if(seriesMatch) {
                           const seriesName = seriesMatch[1].replace(/\[.*?\]/g, '').trim();
                           const seasonNum = seriesMatch[2] || seriesMatch[4];
                           const episodeNum = seriesMatch[3] || seriesMatch[5];

                           if (!seriesMap.has(seriesName)) {
                               seriesMap.set(seriesName, {
                                   name: seriesName,
                                   series_id: seriesName,
                                   cover: currentItem.logo,
                                   episodes: []
                               });
                           }
                           
                           seriesMap.get(seriesName).episodes.push({
                               title: currentItem.raw_title,
                               url: currentItem.url,
                               season: parseInt(seasonNum, 10),
                               episode: parseInt(episodeNum, 10),
                               logo: currentItem.logo
                           });

                        } else if (isLive) {
                            result.live.push(currentItem);
                        } else { 
                            currentItem.stream_icon = currentItem.logo;
                            currentItem.container_extension = url.split('.').pop();
                            result.vod.push(currentItem);
                        }
                        currentItem = {};
                    }
                }
                result.series = Array.from(seriesMap.values());
                return result;
            }
            
            logoutBtn.addEventListener('click', logout);
            mobileLogoutBtn.addEventListener('click', logout);
            
            checkSession();
        });
    </script>
</body>
</html>
