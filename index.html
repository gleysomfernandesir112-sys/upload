<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Fast - IPTV</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/controls.css">
    <style>
        :root {
            --primary-color: #E50914;
            --background-color: #141414;
            --text-color: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            overflow-x: hidden;
            padding-top: 60px; /* Espaço para header mobile */
        }
        
        #login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://image.tmdb.org/t/p/original/VlHt2blBkncfAqPnuTtraG2flp.jpg') no-repeat center center/cover; }
        .app-wrapper { display: none; }
        .app-container { width: 100%; min-height: 100vh; padding-bottom: 80px; }
        
        .login-box { background-color: rgba(0,0,0,0.85); padding: 4rem; border-radius: 8px; max-width: 450px; width: 100%; }
        .login-box h1 { text-align: center; margin-bottom: 2rem; }
        .login-form { display: flex; flex-direction: column; gap: 1rem; }
        .login-form input { background-color: #333; border: none; border-radius: 5px; color: white; padding: 1rem; font-size: 1rem; }
        .login-form button { background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 1rem; font-size: 1.2rem; font-weight: 700; cursor: pointer; margin-top: 1.5rem; }
        #login-error { color: #e87c03; margin-top: 1rem; text-align: center; min-height: 1.2em; }

        .page { display: none; animation: fadeIn 0.4s ease-in-out; }
        .page.active { display: block; }
        .player-page.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mobile-header { display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; background-color: rgba(20, 20, 20, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 101; padding: 1rem 1rem 0.75rem; padding-top: env(safe-area-inset-top, 1rem); border-bottom: 1px solid #333; }
        .mobile-header h1 { font-size: 1.2rem; font-weight: 500; }

        .navbar-desktop { display: none; position: fixed; top: 0; width: 100%; padding: 1rem 3rem; background: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%); align-items: center; z-index: 100; transition: background-color 0.3s; }
        .navbar-desktop .logo { color: var(--primary-color); font-size: 1.8rem; font-weight: 700; margin-right: 2rem; }
        .navbar-desktop .nav-links { list-style: none; display: flex; gap: 1.5rem; flex-grow: 1; align-items: center; }
        .nav-link a { color: var(--text-color); text-decoration: none; font-size: 1rem; transition: color 0.2s; cursor: pointer; }
        .nav-link a:hover, .nav-link a.active { color: #b3b3b3; font-weight: 700; }
        .profile { position: relative; margin-left: auto; }
        .profile img { border-radius: 50%; width: 40px; height: 40px; cursor: pointer; }
        .profile-menu { display: none; position: absolute; right: 0; top: 50px; background-color: #181818; border-radius: 5px; overflow: hidden; }
        .profile:hover .profile-menu { display: block; }
        .profile-menu button { background: none; border: none; color: white; padding: 0.75rem 1.5rem; cursor: pointer; width: 100%; text-align: left; }
        .profile-menu button:hover { background-color: #333; }

        .hero-section { height: 60vh; display: flex; flex-direction: column; justify-content: center; padding: 0 5%; position: relative; background-size: cover; background-position: center center; }
        .hero-content { max-width: 500px; position: relative; z-index: 2; }
        .hero-title { font-size: 2.5rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        
        .media-card { flex: 0 0 150px; aspect-ratio: 10 / 16; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.3s ease; background-color: #222; display: flex; align-items: center; justify-content: center; text-align: center; position: relative; }
        .media-card img { width: 100%; height: 100%; object-fit: cover; }
        .media-card:hover { transform: scale(1.05); }
        .media-card-title { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); font-size: 0.8rem; padding: 5px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }

        .generic-page { padding: 1rem 5%; }
        .loader-container { display: none; text-align: center; padding: 2rem; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .load-sentinel { height: 40px; width: 100%; }
        
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .media-grid .media-card { flex-basis: auto; }

        .player-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 200; display: none; align-items: center; justify-content: center; }
        .player-page video { max-width: 100%; max-height: 100%; outline: none; }
        .back-from-player { position: absolute; top: 2rem; left: 2rem; background: rgba(0,0,0,0.5); border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .back-from-player svg { width: 25px; height: 25px; fill: white; }

        #series-details-backdrop { height: 60vh; background-size: cover; background-position: center top; position: relative; }
        #series-details-backdrop::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, var(--background-color) 10%, transparent 50%); }
        #series-details-info { padding: 2rem 5%; margin-top: -10vh; position: relative; z-index: 2; }
        #series-details-info h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        #series-details-plot { margin-bottom: 1.5rem; color: #ccc; }
        .season-selector { margin-bottom: 2rem; }
        .season-selector select { background: #333; color: white; padding: 0.5rem 1rem; border-radius: 5px; border: 1px solid #555; font-size: 1rem; }
        .episode-list { display: flex; flex-direction: column; gap: 1rem; }
        .episode-item { display: flex; align-items: center; gap: 1rem; background: #222; padding: 1rem; border-radius: 5px; cursor: pointer; }
        .episode-item:hover { background: #333; }
        .episode-item img { width: 150px; height: 84px; object-fit: cover; border-radius: 3px; }

        .navbar-mobile { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background-color: rgba(20, 20, 20, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; z-index: 100; border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { background: none; border: none; color: #8e8e8e; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; cursor: pointer; transition: color 0.2s; flex-grow: 1; }
        .nav-item img { width: 24px; height: 24px; filter: invert(58%); }
        .nav-item.active { color: var(--text-color); }
        .nav-item.active img { filter: none; }
        
        #page-search { padding: 1rem 5%; }
        .search-bar { display: flex; align-items: stretch; background-color: #333; border-radius: 5px; margin-bottom: 2rem; }
        .search-bar input { background: none; border: none; color: white; font-size: 1.2rem; flex-grow: 1; outline: none; padding: 0.75rem 1rem; }
        #search-results h2 { margin-top: 1.5rem; margin-bottom: 1rem; }
        
        #page-profile h2 { margin-bottom: 2rem; text-align: center; font-size: 1.5rem; }
        .logout-button { background-color: var(--primary-color); color: white; border: none; border-radius: 5px; padding: 1rem; font-size: 1.2rem; font-weight: 700; cursor: pointer; width: 100%; max-width: 400px; display: block; margin: 2rem auto 0; }
        .logout-button:hover { background-color: #f40612; }

        @media (min-width: 768px) {
            body { padding-top: 0; }
            .mobile-header { display: none; }
            .app-container { padding-bottom: 0; }
            .navbar-desktop { display: flex; }
            .navbar-mobile { display: none; }
            .hero-section, #series-details-backdrop { height: 80vh; }
            .hero-title, #series-details-info h1 { font-size: 3.5rem; }
            .media-card { flex-basis: 220px; }
            .media-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
            .generic-page { padding-top: 6rem; }
            #page-search { padding-top: 6rem; }
        }
    </style>
</head>
<body>
    <div id="login-container">
        <div class="login-box">
            <h1>Entrar</h1>
            <form id="firebase-login-form" class="login-form active">
                <input type="text" id="user-username" placeholder="Nome de Usuário" required>
                <input type="password" id="user-password" placeholder="Senha" required>
                <button type="submit">Entrar</button>
            </form>
            <div id="login-error"></div>
             <div class="loader-container" id="login-loader">
                <div class="loader"></div>
            </div>
        </div>
    </div>

    <div class="app-wrapper">
        <header class="mobile-header">
            <h1 id="mobile-page-title">Início</h1>
        </header>
        <div class="app-container">
            <nav class="navbar-desktop">
                <div class="logo">FAST</div>
                <ul class="nav-links">
                    <li class="nav-link" data-page="home"><a >Início</a></li>
                    <li class="nav-link" data-page="series"><a >Séries</a></li>
                    <li class="nav-link" data-page="movies"><a >Filmes</a></li>
                    <li class="nav-link" data-page="iptv"><a>Canais Ao Vivo</a></li>
                    <li class="nav-link" data-page="search"><a>Pesquisar</a></li>
                </ul>
                <div class="profile"> 
                    <img src="https://i.pravatar.cc/40" alt="Perfil"> 
                    <div class="profile-menu">
                        <button id="logout-btn">Sair</button>
                    </div>
                </div>
            </nav>

            <main class="main-content">
                <div id="page-home" class="page"><div id="home-content"></div></div>
                <div id="page-series" class="page generic-page"><div id="series-content" class="media-grid"></div></div>
                <div id="page-movies" class="page generic-page"><div id="movies-content" class="media-grid"></div></div>
                <div id="page-iptv" class="page generic-page"><div id="iptv-content" class="media-grid"></div></div>
                <div id="page-search" class="page generic-page">
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Buscar em todo o conteúdo...">
                    </div>
                    <div id="search-results"></div>
                </div>
                <div id="page-series-details" class="page">
                    <div id="series-details-backdrop"></div>
                    <div id="series-details-info">
                        <h1 id="series-details-title"></h1>
                        <p id="series-details-plot"></p>
                        <div class="season-selector">
                            <select id="season-select"></select>
                        </div>
                        <div id="episode-list"></div>
                    </div>
                </div>
                <div id="page-profile" class="page generic-page">
                    <h2>Perfil e Configurações</h2>
                    <button id="mobile-logout-btn" class="logout-button">Sair da Conta</button>
                </div>
            </main>

            <div id="page-player" class="page player-page">
                <button class="back-from-player">
                    <svg viewBox="0 0 24 24"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"></path></svg>
                </button>
                <div data-shaka-player-container style="width: 100%; height: 100%; background-color: black;">
                    <video data-shaka-player autoplay id="shaka-video-player" style="width:100%;height:100%;"></video>
                </div>
            </div>

            <nav class="navbar-mobile">
                <button class="nav-item" data-page="home"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/home.png" alt="Início"/> <span>Início</span> </button>
                <button class="nav-item" data-page="series"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/tv-show.png" alt="Séries"/> <span>Séries</span> </button>
                <button class="nav-item" data-page="movies"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/movie-projector.png" alt="Filmes"/> <span>Filmes</span> </button>
                <button class="nav-item" data-page="iptv"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/playlist.png" alt="IPTV"/> <span>Ao Vivo</span> </button>
                <button class="nav-item" data-page="search"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/search.png" alt="Pesquisar"/> <span>Pesquisar</span> </button>
                <button class="nav-item" data-page="profile"> <img src="https://img.icons8.com/fluency-systems-filled/48/ffffff/user-male-circle.png" alt="Perfil"/> <span>Perfil</span> </button>
            </nav>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/shaka-player.ui.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBC1nI3_95LZTMGRUh_aYUZ6ZCTylXZLl4",
            authDomain: "app-fasthub.firebaseapp.com",
            projectId: "app-fasthub",
            storageBucket: "app-fasthub.firebasestorage.app",
            messagingSenderId: "1022637274457",
            appId: "1:1022637274457:web:42b5f0d4324de68dd2c848"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            const loginContainer = document.getElementById('login-container');
            const appWrapper = document.querySelector('.app-wrapper');
            const mainContent = document.querySelector('.main-content');
            const pages = document.querySelectorAll('.page');
            const desktopLinks = document.querySelectorAll('.navbar-desktop .nav-links .nav-link');
            const mobileLinks = document.querySelectorAll('.navbar-mobile .nav-item');
            const mobilePageTitle = document.getElementById('mobile-page-title');
            const backFromPlayerBtn = document.querySelector('.back-from-player');
            const logoutBtn = document.getElementById('logout-btn');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
            const loginForm = document.getElementById('firebase-login-form');
            const loginError = document.getElementById('login-error');
            const loginLoader = document.getElementById('login-loader');
            const searchInput = document.getElementById('search-input');
            const searchResultsContainer = document.getElementById('search-results');
            
            let lastPageId = 'home';
            let activeUser = null;
            let appData = { vodStreams: [], series: [], liveStreams: [] };
            let renderState = {};
            const RENDER_BATCH_SIZE = 100;
            let lazyLoadObserver;
            let searchTimeout;

            const videoElement = document.getElementById('shaka-video-player');
            let shakaPlayer = null;
            let shakaUi = null;

            function initShakaPlayer() {
                shaka.polyfill.installAll();
                if (shaka.Player.isBrowserSupported()) {
                    shakaPlayer = new shaka.Player(videoElement);
                    shakaUi = new shaka.ui.Overlay(shakaPlayer, videoElement.parentElement, videoElement);
                    shakaUi.getControls();
                    shakaPlayer.addEventListener('error', onPlayerError);
                } else {
                    console.error('Browser not supported by Shaka Player!');
                }
            }

            function onPlayerError(event) {
                console.error('Shaka Player Error:', event.detail);
            }

            initShakaPlayer();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    loginLoader.style.display = 'block';
                    const username = user.email.split('@')[0];
                    const userDoc = await getDoc(doc(db, "users", username));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        await loginWithXtream(userData.xtreamUrl, userData.xtreamUser, userData.xtreamPass);
                    } else {
                        showLoginError("Dados de usuário não encontrados.");
                        logout();
                    }
                } else {
                    appWrapper.style.display = 'none';
                    loginContainer.style.display = 'flex';
                    loginLoader.style.display = 'none';
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                loginLoader.style.display = 'block';
                const username = document.getElementById('user-username').value;
                const password = document.getElementById('user-password').value;
                const email = `${username}@appfast.cloud`;
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => {
                        showLoginError("Usuário ou senha inválidos.");
                        console.error("Login error:", error);
                    });
            });

            function showLoginError(message) {
                loginError.textContent = message;
                loginLoader.style.display = 'none';
            }

            function showApp() {
                loginContainer.style.display = 'none';
                appWrapper.style.display = 'block';
                updateNavigation();
                showPage('home');
            }

            function initializeLazyLoader() {
                if (lazyLoadObserver) lazyLoadObserver.disconnect();
                const options = { root: null, rootMargin: '0px 0px 500px 0px', threshold: 0 };
                lazyLoadObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const sentinel = entry.target;
                            const { stateKey, pageId } = sentinel.dataset;
                            loadMoreItems(document.getElementById(`${pageId}-content`), sentinel, stateKey, pageId, observer);
                        }
                    });
                }, options);
            }
            
            async function fetchAPI(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response;
                } catch (error) {
                    if (error instanceof TypeError) throw new Error(`Falha na rede ou erro de CORS.`);
                    throw error;
                }
            }

            async function fetchXtreamData(url, user, pass, action) {
                const targetUrl = `${url}/player_api.php?username=${user}&password=${pass}&action=${action}`;
                const response = await fetchAPI(targetUrl);
                const textData = await response.text();
                try {
                    if (textData.trim() === '[]') return [];
                    const data = JSON.parse(textData);
                    if (data.user_info && data.user_info.auth === 0) throw new Error('Credenciais inválidas.');
                    return data;
                } catch(e) {
                    throw new Error('Resposta inválida do servidor (não é JSON).');
                }
            }

            async function loginWithXtream(url, user, pass) {
                loginError.textContent = '';
                try {
                    await fetchXtreamData(url, user, pass, 'get_user_info');
                    const [liveStreams, vodStreams, series] = await Promise.all([
                        fetchXtreamData(url, user, pass, 'get_live_streams'),
                        fetchXtreamData(url, user, pass, 'get_vod_streams'),
                        fetchXtreamData(url, user, pass, 'get_series'),
                    ]);
                    appData = { liveStreams, vodStreams, series };
                    activeUser = { type: 'xtream', url, user, pass };
                    renderAllPages();
                    showApp();
                } catch (error) {
                    showLoginError(error.message || 'Falha ao carregar dados.');
                    logout();
                } finally {
                    loginLoader.style.display = 'none';
                }
            }
            
            function renderAllPages() {
                renderState = {};
                initializeLazyLoader();
                renderHomePage();
                renderGridPage('movies', appData.vodStreams);
                renderGridPage('series', appData.series);
                renderGridPage('iptv', appData.liveStreams);
            }

            function renderHomePage() {
                const homeContent = document.getElementById('home-content');
                const firstItem = appData.vodStreams?.[0] || appData.series?.[0] || appData.liveStreams?.[0];
                if (!firstItem) {
                    homeContent.innerHTML = '<div class="generic-page"><h1>Bem-vindo!</h1><p>Navegue pelas seções para encontrar conteúdo.</p></div>';
                    return;
                }
                const title = firstItem.name;
                const image = firstItem.stream_icon || firstItem.cover;
                homeContent.innerHTML = `
                    <header class="hero-section" style="background-image: linear-gradient(to top, #141414 10%, transparent 50%), url('${image}');">
                        <div class="hero-content">
                            <h1 class="hero-title">${title}</h1>
                        </div>
                    </header>
                `;
            }

            function renderGridPage(pageId, items) {
                const container = document.getElementById(`${pageId}-content`);
                container.innerHTML = '';
                if (!items || items.length === 0) return;
                
                const sentinel = document.createElement('div');
                sentinel.className = 'load-sentinel';
                container.after(sentinel);
                
                const stateKey = `${pageId}-grid`;
                renderState[stateKey] = { items: items, nextIndex: 0 };
                
                sentinel.dataset.stateKey = stateKey;
                sentinel.dataset.pageId = pageId;

                lazyLoadObserver.observe(sentinel);
            }

            function loadMoreItems(container, sentinel, stateKey, pageId, observer) {
                const state = renderState[stateKey];
                if (!state) return;
                observer.unobserve(sentinel);

                const itemsToRender = state.items.slice(state.nextIndex, state.nextIndex + RENDER_BATCH_SIZE);
                let cardsHtml = '';
                itemsToRender.forEach(item => {
                    cardsHtml += createCardHtml(item, pageId);
                });

                container.insertAdjacentHTML('beforeend', cardsHtml);
                state.nextIndex += itemsToRender.length;
                
                if (state.nextIndex < state.items.length) {
                    observer.observe(sentinel);
                } else {
                    sentinel.remove();
                }
            }

            function createCardHtml(item, pageId) {
                const streamId = item.stream_id || item.series_id;
                const title = item.name;
                const image = item.stream_icon || item.cover || item.logo;
                let streamUrl = '';
                let seriesId = '';
                
                if (activeUser.type === 'xtream') {
                    const extension = item.container_extension || 'mp4';
                    streamUrl = pageId === 'movies' ? `${activeUser.url}/movie/${activeUser.user}/${activeUser.pass}/${streamId}.${extension}` : (pageId === 'iptv' ? `${activeUser.url}/live/${activeUser.user}/${activeUser.pass}/${streamId}.m3u8` : '');
                    seriesId = pageId === 'series' ? streamId : '';
                } else { 
                    if (pageId === 'series') {
                        seriesId = item.name;
                    } else {
                        streamUrl = item.url;
                    }
                }

                return `
                    <div class="media-card" data-stream-url="${streamUrl}" data-series-id="${seriesId}">
                        <img src="${image}" alt="${title}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/222/fff?text=${encodeURIComponent(title)}';">
                        <div class="media-card-title">${title}</div>
                    </div>`;
            }

            function performSearch(query) {
                if (!query) {
                    searchResultsContainer.innerHTML = '';
                    return;
                }
                const lowerQuery = query.toLowerCase();
                const results = {
                    Filmes: appData.vodStreams.filter(i => i.name.toLowerCase().includes(lowerQuery)),
                    Séries: appData.series.filter(i => i.name.toLowerCase().includes(lowerQuery)),
                    "Canais Ao Vivo": appData.liveStreams.filter(i => i.name.toLowerCase().includes(lowerQuery)),
                };
                
                searchResultsContainer.innerHTML = '';
                for (const [category, items] of Object.entries(results)) {
                    if (items.length > 0) {
                        let cardsHtml = items.map(item => {
                            const pageId = category === 'Filmes' ? 'movies' : (category === 'Séries' ? 'series' : 'iptv');
                            return createCardHtml(item, pageId);
                        }).join('');
                        searchResultsContainer.innerHTML += `<h2>${category} (${items.length})</h2><div class="media-grid">${cardsHtml}</div>`;
                    }
                }
                if (searchResultsContainer.innerHTML === '') {
                    searchResultsContainer.innerHTML = `<p>Nenhum resultado encontrado para "${query}"</p>`;
                }
            }
            
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(searchInput.value);
                }, 300);
            });

            async function renderSeriesDetailsPage(seriesId) {
                try {
                    const seriesInfo = await fetchXtreamData(activeUser.url, activeUser.user, activeUser.pass, `get_series_info&series_id=${seriesId}`);
                    
                    document.getElementById('series-details-backdrop').style.backgroundImage = `url('${seriesInfo.info.backdrop_path?.[0] || ''}')`;
                    document.getElementById('series-details-title').textContent = seriesInfo.info.name;
                    document.getElementById('series-details-plot').textContent = seriesInfo.info.plot;
                    
                    const seasonSelect = document.getElementById('season-select');
                    seasonSelect.innerHTML = '';
                    if (seriesInfo.episodes) {
                        Object.keys(seriesInfo.episodes).forEach(seasonNum => {
                            const option = document.createElement('option');
                            option.value = seasonNum;
                            option.textContent = `Temporada ${seasonNum}`;
                            seasonSelect.appendChild(option);
                        });

                        const renderEpisodes = (seasonNum) => {
                            const episodeList = document.getElementById('episode-list');
                            episodeList.innerHTML = '';
                            seriesInfo.episodes[seasonNum].forEach(ep => {
                                const epUrl = `${activeUser.url}/series/${activeUser.user}/${activeUser.pass}/${ep.id}.${ep.container_extension}`;
                                const item = document.createElement('div');
                                item.className = 'episode-item';
                                item.dataset.streamUrl = epUrl;
                                item.innerHTML = `
                                    <img src="${ep.info.movie_image}" onerror="this.onerror=null;this.style.display='none';">
                                    <div>
                                        <strong>${ep.episode_num}. ${ep.title}</strong>
                                        <p>${ep.info.plot || ''}</p>
                                    </div>
                                `;
                                episodeList.appendChild(item);
                            });
                        };

                        seasonSelect.onchange = () => renderEpisodes(seasonSelect.value);
                        renderEpisodes(Object.keys(seriesInfo.episodes)[0]);
                    }
                    showPage('series-details');
                } catch (error) {
                    console.error('Error fetching series details:', error);
                }
            }

            function logout() {
                signOut(auth);
            }

            function showPage(pageId) {
                if (pageId !== 'player' && pageId !== 'series-details') lastPageId = pageId;
                pages.forEach(page => page.classList.remove('active'));
                const newPage = document.getElementById(`page-${pageId}`);
                if (newPage) newPage.classList.add('active');

                const titleMap = { home: 'Início', series: 'Séries', movies: 'Filmes', iptv: 'Canais Ao Vivo', search: 'Pesquisar', profile: 'Perfil' };
                mobilePageTitle.textContent = titleMap[pageId] || 'Início';

                if (pageId !== 'player') {
                    window.scrollTo(0, 0);
                    desktopLinks.forEach(link => { link.querySelector('a').classList.toggle('active', link.dataset.page === pageId); });
                    mobileLinks.forEach(link => { link.classList.toggle('active', link.dataset.page === pageId) });
                }
            }

             function updateNavigation() {
                const navLinks = [...desktopLinks, ...mobileLinks];
                navLinks.forEach(link => {
                    const page = link.dataset.page;
                    let shouldShow = true;
                    link.style.display = shouldShow ? '' : 'none';
                });
             }

            [...desktopLinks, ...mobileLinks].forEach(link => {
                const pageId = link.dataset.page;
                const target = link.tagName === 'LI' ? link.querySelector('a') : link;
                target.addEventListener('click', (e) => { e.preventDefault(); showPage(pageId); });
            });

            async function openPlayer(streamUrl) {
                if (!streamUrl || !shakaPlayer) return;
                showPage('player');
                try {
                    await shakaPlayer.load(streamUrl);
                } catch (e) {
                    console.error('Error loading stream with Shaka Player:', e);
                }
            }
            
            mainContent.addEventListener('click', (event) => {
                const card = event.target.closest('.media-card, .episode-item');
                if (!card) return;
                
                if (card.dataset.seriesId) {
                    if (activeUser.type === 'xtream') {
                        renderSeriesDetailsPage(card.dataset.seriesId);
                    } 
                } else if (card.dataset.streamUrl) {
                    openPlayer(card.dataset.streamUrl);
                }
            });

            backFromPlayerBtn.addEventListener('click', () => {
                const isSeriesDetailsActive = document.getElementById('page-series-details').classList.contains('active');
                showPage(isSeriesDetailsActive ? 'series-details' : lastPageId);
                
                if (shakaPlayer) {
                    shakaPlayer.unload();
                }
            });
            
            logoutBtn.addEventListener('click', logout);
            mobileLogoutBtn.addEventListener('click', logout);
        });
    </script>
</body>
</html>